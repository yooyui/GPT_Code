@echo off
chcp 65001
setlocal enabledelayedexpansion

:: Set the project's root directory, using a dot (.) to represent the current directory
SET "BASE_DIR=."

:: Variable for storing the list of found top-level node_modules directories
SET "NODE_MODULES_LIST=node_modules_list.txt"

:: Clear the previous list file (if it exists)
IF EXIST "%NODE_MODULES_LIST%" del /q "%NODE_MODULES_LIST%"

:: Find all top-level node_modules directories and save them to a file
echo Searching for top-level node_modules directories, please wait...
for /r "%BASE_DIR%" %%d in (node_modules) do (
    if exist "%%d" (
        :: Check if it's already listed
        set "alreadyListed=false"
        for /f "tokens=*" %%p in (%NODE_MODULES_LIST%) do (
            if "%%d"=="%%p\node_modules" set "alreadyListed=true"
        )
        if not !alreadyListed! == true (
            echo Found: %%d
            >> "%NODE_MODULES_LIST%" echo %%d
            :: Skip traversing subdirectories of node_modules under the current path
            set "skip=%%d\*"
        )
    )
)

:: Check if any top-level node_modules directories were found
IF NOT EXIST "%NODE_MODULES_LIST%" (
    echo No top-level node_modules directories found.
    goto :eof
)

:: Prompt the user whether to delete the found top-level node_modules directories
echo.
set /p choice="Do you want to delete all the above top-level node_modules directories? [y/n]: "
if /i "%choice%" neq "y" (
    echo Deletion cancelled.
    del /q "%NODE_MODULES_LIST%"
    goto :eof
)

:: Delete the top-level node_modules directories
for /f "tokens=*" %%i in (%NODE_MODULES_LIST%) do (
    if exist "%%i" (
        echo Deleting: %%i
        rmdir /s /q "%%i"
    )
)

:: Delete temporary file and exit
del /q "%NODE_MODULES_LIST%"
echo Deletion complete!
pause
