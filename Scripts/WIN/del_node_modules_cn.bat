@echo off
chcp 65001
setlocal enabledelayedexpansion

:: 设置项目的根目录，使用点(.)表示当前目录
SET "BASE_DIR=."

:: 用于存储找到的node_modules顶级目录
SET "NODE_MODULES_LIST=node_modules_list.txt"

:: 清空之前的列表文件（如果存在）
IF EXIST "%NODE_MODULES_LIST%" del /q "%NODE_MODULES_LIST%"

:: 查找所有的node_modules顶级目录并保存到文件
echo 正在寻找 node_modules 顶级目录，请稍候...
for /r "%BASE_DIR%" %%d in (node_modules) do (
    if exist "%%d" (
        :: 检查是否已经在列表中
        set "alreadyListed=false"
        for /f "tokens=*" %%p in (%NODE_MODULES_LIST%) do (
            if "%%d"=="%%p\node_modules" set "alreadyListed=true"
        )
        if not !alreadyListed! == true (
            echo 找到: %%d
            >> "%NODE_MODULES_LIST%" echo %%d
            :: 跳过当前路径下的node_modules子目录的遍历
            set "skip=%%d\*"
        )
    )
)

:: 检查是否找到node_modules顶级目录
IF NOT EXIST "%NODE_MODULES_LIST%" (
    echo 没有找到 node_modules 顶级目录.
    goto :eof
)

:: 提示用户是否删除找到的node_modules顶级目录
echo.
set /p choice="是否删除上述所有node_modules顶级目录? [y/n]: "
if /i "%choice%" neq "y" (
    echo 已取消删除操作.
    del /q "%NODE_MODULES_LIST%"
    goto :eof
)

:: 删除node_modules顶级目录
for /f "tokens=*" %%i in (%NODE_MODULES_LIST%) do (
    if exist "%%i" (
        echo 正在删除: %%i
        rmdir /s /q "%%i"
    )
)

:: 删除临时文件并退出
del /q "%NODE_MODULES_LIST%"
echo 删除完成!
pause
